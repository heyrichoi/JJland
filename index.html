<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JJëœë“œ ë£°ë ›</title>
<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    padding: 24px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
    background: #000 url('https://github.com/heyrichoi/JJland/raw/main/%EC%A0%9C%EB%AA%A9%20%EC%97%86%EC%9D%8C-1.png') center/cover no-repeat fixed;
    color: #fef3c7;
    display: flex;
    justify-content: center;
    min-height: 100vh;
  }
  .app {
    max-width: 1200px;
    width: min(1200px, 100%);
    background: radial-gradient(circle at top left, rgba(15,23,42,0.98), rgba(15,23,35,0.99));
    border-radius: 24px;
    padding: 20px 22px 26px;
    box-shadow: 0 0 40px rgba(15,23,42,0.9), 0 28px 80px rgba(0,0,0,0.95);
    border: 1px solid rgba(248,181,71,0.65);
    position: relative;
    z-index: 1;
    height: fit-content;
  }
  .app-header {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 6px 4px 18px;
    border-bottom: 1px solid rgba(31,41,55,0.9);
    margin-bottom: 10px;
  }
  .title-section {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
  }
  .title-logo-wrap {
    width: 150px;
    height: 150px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .title-logo {
    width: 100%;
    height: auto;
    object-fit: contain;
  }
  .app-main {
    display: grid;
    grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
    gap: 18px;
  }
  .controls-shell {
    padding: 14px 14px 12px;
    border-radius: 16px;
    background: radial-gradient(circle at top left, rgba(15,23,42,0.96), rgba(21,24,33,0.98));
    box-shadow: inset 0 0 0 1px rgba(31,41,55,0.9);
  }
  .controls-group { margin-bottom: 18px; }
  .section-title {
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #9ca3af;
    margin-bottom: 4px;
  }
  label {
    display: block;
    font-size: 0.8rem;
    color: #e5e7eb;
    margin-bottom: 4px;
  }
  select, input[type="number"], input[type="text"] {
    background: #020617;
    border-radius: 9px;
    border: 1px solid rgba(55,65,81,0.9);
    color: #e5e7eb;
    padding: 7px 9px;
    font-size: 0.85rem;
    outline: none;
    width: 100%;
  }
  select:focus, input:focus {
    border-color: rgba(248,181,71,0.9);
    box-shadow: 0 0 0 1px rgba(248,181,71,0.7);
  }
  .row {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .items-editor {
    margin-top: 10px;
    max-height: 220px;
    overflow: auto;
    padding-right: 4px;
  }
  .items-editor::-webkit-scrollbar {
    width: 6px;
  }
  .items-editor::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.2);
    border-radius: 3px;
  }
  .items-editor::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.2);
    border-radius: 3px;
  }
  .item-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
  }

  /* ìŠ¤íƒ(ì§€ë¶„) ìŠ¤í…í¼ UI (ì²¨ë¶€ ì´ë¯¸ì§€ ëŠë‚Œ) */
  .stack-stepper {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    border-radius: 999px;
    background: rgba(2,6,23,0.85);
    border: 1px solid rgba(55,65,81,0.9);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05);
  }
  .stack-btn {
    width: 24px;
    height: 22px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(15,23,42,0.65);
    color: #c7d2fe;
    display: grid;
    place-items: center;
    cursor: pointer;
    transition: transform 0.12s ease, background 0.12s ease, border 0.12s ease;
    user-select: none;
  }
  .stack-btn:hover {
    transform: translateY(-1px);
    background: rgba(129,140,248,0.18);
    border-color: rgba(129,140,248,0.35);
  }
  .stack-btn:active {
    transform: translateY(0px);
  }
  .stack-value {
    min-width: 28px;
    text-align: center;
    font-weight: 800;
    font-size: 0.9rem;
    color: #67e8f9;
  }

  .item-badge {
    min-width: 26px;
    height: 26px;
    border-radius: 999px;
    background: radial-gradient(circle at 30% 30%, #fed7aa, #fb923c);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.78rem;
    font-weight: 700;
    color: #111827;
    box-shadow: 0 0 10px rgba(248,181,71,0.7);
  }
  .item-remove {
    width: 22px;
    height: 22px;
    border-radius: 999px;
    border: none;
    background: transparent;
    color: #9ca3af;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: color 0.15s ease, background 0.15s ease, transform 0.15s ease;
  }
  .item-remove:hover {
    color: #fecaca;
    background: rgba(239,68,68,0.2);
    transform: translateY(-1px);
  }
  .btn-primary, .btn-secondary {
    border-radius: 999px;
    border: none;
    cursor: pointer;
    padding: 8px 16px;
    font-size: 0.86rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
    white-space: nowrap;
  }
  .btn-primary {
    background: radial-gradient(circle at 20% 0%, #fb923c, #f97316 35%, #facc15 100%);
    color: #111827;
    box-shadow: 0 12px 30px rgba(248,153,29,0.7);
  }
  .btn-primary:hover {
    transform: translateY(-1px) scale(1.01);
    box-shadow: 0 16px 40px rgba(248,153,29,0.9);
  }
  .btn-secondary {
    background: rgba(15,23,42,0.96);
    color: #e5e7eb;
    border: 1px solid rgba(75,85,99,0.9);
  }
  .btn-secondary:hover {
    background: rgba(30,64,175,0.4);
    border-color: rgba(129,140,248,0.9);
  }
  .btn-chip {
    padding-inline: 10px;
    font-size: 0.78rem;
  }
  .btn-add-full {
    width: 100%;
    margin-top: 8px;
    padding: 10px;
    border-radius: 12px;
    border: none;
    background: radial-gradient(circle at 50% 0%, #fb923c, #f97316);
    color: #111827;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
    font-size: 0.9rem;
  }
  .btn-add-full:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(249, 115, 22, 0.6);
  }
  .btn-add-full:active {
    transform: translateY(1px);
    box-shadow: 0 2px 8px rgba(249, 115, 22, 0.4);
  }
  .checkbox-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    font-size: 0.8rem;
  }
  .checkbox-row input[type="checkbox"] {
    width: 14px;
    height: 14px;
  }
  .current-options {
    margin-top: 10px;
    font-size: 0.78rem;
  }
  .current-options span {
    display: inline-block;
    background: rgba(248,181,71,0.18);
    padding: 3px 8px;
    border-radius: 999px;
    margin: 0 4px 4px 0;
    border: 1px solid rgba(254,243,199,0.7);
  }

  .donation-export {
    margin-top: 10px;
    padding: 10px;
    border-radius: 14px;
    background: rgba(2,6,23,0.55);
    border: 1px solid rgba(55,65,81,0.7);
  }
  .donation-export-row {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  #donationExportText {
    flex: 1;
    background: rgba(2,6,23,0.9);
  }

  .toast {
    position: fixed;
    left: 50%;
    bottom: 26px;
    transform: translateX(-50%);
    background: rgba(2,6,23,0.92);
    border: 1px solid rgba(248,181,71,0.75);
    color: #fef3c7;
    padding: 10px 14px;
    border-radius: 999px;
    font-size: 0.85rem;
    box-shadow: 0 18px 45px rgba(0,0,0,0.6);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.18s ease, transform 0.18s ease;
    z-index: 3000;
  }
  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(-6px);
  }

  .hint {
    font-size: 0.72rem;
    color: #9ca3af;
    margin-top: 4px;
  }
  .roulette-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 18px;
    padding: 16px 10px 10px;
    background: radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(15,23,42,0.98));
    border-radius: 18px;
    box-shadow: inset 0 0 0 1px rgba(31,41,55,0.9);
    transition: all 0.5s ease;
  }
  /* ì „ì²´ í™”ë©´ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
  .roulette-wrapper.fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 1000;
    border-radius: 0;
    justify-content: center;
    background: radial-gradient(circle at center, #1e293b, #0f172a);
    padding: 40px;
  }
  /* ìŠ¤í•€ ì¤‘ì—ëŠ” ë¶ˆí•„ìš”í•œ ìš”ì†Œ ìˆ¨ê¹€ (ë©ˆì¶”ê¸° ë²„íŠ¼ì€ ìœ ì§€) */
  .roulette-wrapper.fullscreen .roulette-title,
  .roulette-wrapper.fullscreen .roulette-subtitle,
  .roulette-wrapper.fullscreen .speed-row,
  .roulette-wrapper.fullscreen .result-box {
    display: none;
  }
  .roulette-wrapper.fullscreen #spinBtn {
    display: inline-flex;
    position: fixed;
    left: 50%;
    bottom: 28px;
    transform: translateX(-50%);
    z-index: 1200;
  }

  /* ìŠ¤í•€ ì¤‘(ë©ˆì¶”ê¸° ëª¨ë“œ) ë²„íŠ¼ í¬ê²Œ (ìš”ì²­: í›¨ì”¬ ë” í¬ê²Œ) */
  #spinBtn.stop-mode {
    font-size: 1.55rem;
    padding: 20px 44px;
    min-width: 360px;
    min-height: 74px;
    box-shadow: 0 22px 70px rgba(248,153,29,0.98);
  }
  .roulette-wrapper.fullscreen #spinBtn.stop-mode {
    font-size: clamp(1.7rem, 3.6vw, 2.4rem);
    padding: 22px 56px;
    min-width: min(82vw, 640px);
    min-height: 86px;
    border-radius: 999px;
  }
  #spinBtn.stop-mode:disabled {
    opacity: 0.92;
    cursor: not-allowed;
  }

  .roulette-title {
    font-size: 0.9rem;
    font-weight: 600;
  }
  .roulette-subtitle {
    font-size: 0.78rem;
    color: #9ca3af;
  }
  .wheel-container {
    position: relative;
    width: 360px;
    height: 360px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.5s ease;
  }
  .wheel-ring {
    position: absolute;
    inset: 12px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 20%, rgba(148,163,184,0.25), rgba(15,23,42,1));
    box-shadow: 0 18px 45px rgba(0,0,0,0.85);
  }
  .wheel-shell {
    position: absolute;
    inset: 40px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 20%, rgba(15,23,42,0.9), #020617);
  }
  .wheel {
    position: relative;
    width: 82%;
    height: 82%;
    border-radius: 50%;
    border: 6px solid rgba(15,23,42,0.95);
    box-shadow: 0 0 0 3px rgba(15,23,42,0.9), 0 10px 24px rgba(15,23,42,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    transform: rotate(0deg);
  }
  .wheel-center {
    position: absolute;
    width: 90px;
    height: 90px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, #111827, #020617 70%, #000 100%);
    box-shadow: 0 0 0 4px rgba(15,23,42,0.95), 0 0 26px rgba(15,23,42,0.9);
    z-index: 3;
  }
  .pointer {
    position: absolute;
    top: -6px;
    left: 50%;
    transform: translateX(-50%);
    width: 52px;
    height: 52px;
    z-index: 5;
    pointer-events: none;
    filter: drop-shadow(0 0 10px rgba(250,204,21,0.9));
  }
  .wheel-labels {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }
  .slice-label {
    position: absolute;
    left: 50%;
    top: 50%;
    transform-origin: 50% 50%;
  }
  .slice-label span {
    position: absolute;
    left: 50%;
    top: 50%;
    transform-origin: 50% 50%;
    min-width: 0;
    max-width: 80px;
    font-size: 0.72rem;
    font-weight: 600;
    color: #111827;
    text-align: center;
    word-break: keep-all;
    writing-mode: vertical-rl;
    text-orientation: mixed;
    text-shadow: 0 0 3px rgba(255,255,255,0.9);
    transform: translate(-50%, -50%);
  }
  .result-box {
    text-align: center;
    margin-top: 4px;
  }
  .result-title {
    font-size: 0.8rem;
    color: #9ca3af;
    margin-bottom: 4px;
  }
  .result-value {
    min-height: 24px;
    font-size: 1rem;
    font-weight: 600;
  }

  /* ì „ì²´ í™”ë©´ ê²°ê³¼ íŒì—… */
  .result-overlay {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: radial-gradient(circle at center, rgba(0,0,0,0.7), rgba(0,0,0,0.9));
    backdrop-filter: blur(4px);
    z-index: 2000;
    cursor: pointer;
  }
  .result-modal {
    position: relative;
    width: min(85vw, 1100px);
    min-height: min(70vh, 600px);
    padding: 80px 40px 36px;
    border-radius: 40px;
    background: radial-gradient(circle at top left, #fde68a, #f97316 40%, #ea580c 95%);
    box-shadow: 0 24px 80px rgba(0,0,0,0.9);
    border: 2px solid rgba(248,181,71,0.95);
    text-align: center;
    overflow: visible;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  .result-modal-logo {
    position: absolute;
    top: -90px;
    left: 50%;
    transform: translateX(-50%);
    width: 200px;
    height: auto;
    z-index: 3;
    display: block;
    pointer-events: none;
    filter: drop-shadow(0 12px 20px rgba(0,0,0,0.8));
  }
  .result-modal-text {
    margin-top: 30px;
    font-size: clamp(3rem, 7vw, 6rem);
    font-weight: 900;
    color: #fefce8;
    letter-spacing: 0.06em;
    text-shadow: 0 3px 8px rgba(0,0,0,0.4);
    word-break: keep-all;
    line-height: 1.2;
  }
  .result-modal-sub {
    margin-top: 22px;
    font-size: 1.2rem;
    color: #fef9c3;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
  }
  .fireworks {
    position: absolute;
    inset: -120px;
    pointer-events: none;
    z-index: 1;
  }
  .fireworks::before,
  .fireworks::after,
  .fireworks .ring {
    content: "";
    position: absolute;
    left: 50%;
    top: 50%;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: transparent;
  }
  .fireworks::before {
    box-shadow:
      0 -120px 0 0 #fef3c7,
      90px -90px 0 0 #fca5a5,
      130px 0 0 0 #bfdbfe,
      90px 90px 0 0 #a7f3d0,
      0 120px 0 0 #f9a8d4,
      -90px 90px 0 0 #e5e7eb,
      -130px 0 0 0 #fed7aa,
      -90px -90px 0 0 #fee2e2;
    animation: explode 1.6s ease-out infinite;
  }
  .fireworks::after {
    box-shadow:
      0 -90px 0 0 #facc15,
      80px -50px 0 0 #fb7185,
      120px 35px 0 0 #38bdf8,
      0 90px 0 0 #4ade80,
      -80px 50px 0 0 #c4b5fd,
      -120px -35px 0 0 #f97316;
    animation: explode 1.9s ease-out infinite;
    animation-delay: 0.25s;
  }
  .fireworks .ring {
    box-shadow:
      0 -110px 0 0 #fef3c7,
      95px -70px 0 0 #bef264,
      140px 20px 0 0 #38bdf8,
      60px 105px 0 0 #fb7185,
      -60px 105px 0 0 #c7d2fe,
      -140px 20px 0 0 #fbbf24,
      -95px -70px 0 0 #f9a8d4;
    animation: explode 2.2s ease-out infinite;
    animation-delay: 0.5s;
  }
  @keyframes explode {
    0%    { transform: translate(-50%, -50%) scale(0.15); opacity: 0; }
    15%   { opacity: 1; }
    80%   { opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(1.4); opacity: 0; }
  }

  /* âœ… í•œë²ˆë” ì˜¤ë²„ë ˆì´ */
  .one-more-overlay {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1800;
    background: radial-gradient(circle at center, rgba(0,0,0,0.15), rgba(0,0,0,0.60));
    backdrop-filter: blur(3px);
    pointer-events: none;
    opacity: 0;
    transform: scale(0.98);
    transition: opacity 0.22s ease, transform 0.22s ease;
  }
  .one-more-overlay.show {
    opacity: 1;
    transform: scale(1);
  }
  .one-more-img {
    width: min(66vw, 520px);
    height: auto;
    filter: drop-shadow(0 18px 40px rgba(0,0,0,0.75));
    animation: oneMorePop 0.7s ease both;
  }
  @keyframes oneMorePop {
    0% { transform: translateY(14px) scale(0.92); opacity: 0; }
    45% { opacity: 1; }
    100% { transform: translateY(0) scale(1); opacity: 1; }
  }

  @media (max-width: 880px) {
    body { padding: 16px; }
    .app-main { grid-template-columns: minmax(0,1fr); }
    .wheel-container { width: 300px; height: 300px; }
  }
  @media (max-width: 640px) {
    body { padding: 10px; }
    .app { border-radius: 18px; padding: 14px 14px 18px; }
    .wheel-container { width: 260px; height: 260px; }
    .result-modal {
      width: min(92vw, 520px);
      min-height: 260px;
      padding: 70px 18px 24px;
      border-radius: 30px;
    }
    .result-modal-logo { top: -70px; width: 160px; }
    .result-modal-text {
      font-size: clamp(2.4rem, 8vw, 3.8rem);
      margin-top: 24px;
    }
  }
</style>
</head>
<body>
<div class="app">
  <header class="app-header">
    <div class="title-section">
      <div class="title-logo-wrap">
        <img class="title-logo" src="https://github.com/heyrichoi/JJland/blob/main/%EB%A3%B0%EB%A0%9B%20%EB%A1%9C%EA%B3%A0.png?raw=true" alt="JJ Land Logo" />
      </div>
    </div>
  </header>

  <main class="app-main">
    <section class="controls-shell">
      <div class="controls-group">
        <div class="section-title">PRESET</div>
        <label>í”„ë¦¬ì…‹ ì„ íƒ</label>
        <select id="presetSelect"></select>
        <div class="row" style="margin-top:6px;">
          <button class="btn-secondary btn-chip" id="donationModeBtn">ë„ë„¤ ë£°ë ›ìœ¼ë¡œ ì „í™˜</button>
        </div>
      </div>

      <div class="controls-group">
        <div class="section-title">ITEMS</div>
        <label>í•­ëª© ê°œìˆ˜</label>
        <div class="row">
          <input type="number" id="itemCount" min="1" max="20" />
          <button class="btn-secondary" id="presetInit">í”„ë¦¬ì…‹ ì´ˆê¸°í™”</button>
        </div>

        <div class="items-editor" id="itemsEditor"></div>
        <button id="addItemBtn" class="btn-add-full">+ í•­ëª© ì¶”ê°€</button>

        <div class="checkbox-row">
          <input type="checkbox" id="removeOnWin" />
          <label for="removeOnWin">ë‹¹ì²¨ëœ ìºë¦­í„° ì œê±°</label>
          <button class="btn-secondary btn-chip" id="restorePrev">ì§ì „ ìºë¦­í„° ë‹¤ì‹œ ì¶”ê°€</button>
        </div>

        <div class="current-options" id="currentOptions"></div>

        <!-- ë„ë„¤ ë£°ë › í…ìŠ¤íŠ¸ ë‚´ë³´ë‚´ê¸° (í´ë¦½ë³´ë“œ) -->
        <div class="donation-export" id="donationExportWrap" style="display:none;">
          <div class="donation-export-row">
            <input type="text" id="donationExportText" readonly placeholder="ì˜ˆ: ì§±êµ¬*5,ì§±ì•„*10" />
            <button class="btn-secondary btn-chip" id="copyDonationBtn">ë³µì‚¬</button>
          </div>
          <div class="hint">ë„ë„¤ ë£°ë › í•­ëª©(ì´ë¦„/ì§€ë¶„)ì„ "ì´ë¦„*ì§€ë¶„" í˜•íƒœë¡œ í•©ì³ì„œ ë³µì‚¬í•©ë‹ˆë‹¤.</div>
        </div>
      </div>

      <div class="controls-group" id="refundGroup">
        <div class="section-title">í™˜ë¶ˆ ë°°ìˆ˜ ë£°ë ›</div>
        <div class="row">
          <label>ë°›ì€ ë²„ìŠ¤ë¹„</label>
          <input type="number" id="refundBase" />
        </div>
        <div class="row" style="margin-top:6px; flex-wrap:wrap;">
          <button class="btn-secondary btn-chip refund-btn" data-x="0">0ë°°</button>
          <button class="btn-secondary btn-chip refund-btn" data-x="1">1ë°°</button>
          <button class="btn-secondary btn-chip refund-btn" data-x="1.5">1.5ë°°</button>
          <button class="btn-secondary btn-chip refund-btn" data-x="2">2ë°°</button>
          <button class="btn-secondary btn-chip refund-btn" data-x="2.5">2.5ë°°</button>
          <button class="btn-secondary btn-chip refund-btn" data-x="3">3ë°°</button>
          <button class="btn-secondary btn-chip refund-btn" data-x="3.5">3.5ë°°</button>
          <button class="btn-secondary btn-chip refund-btn" data-x="4">4ë°°</button>
          <button class="btn-secondary btn-chip refund-btn" data-x="4.5">4.5ë°°</button>
          <button class="btn-secondary btn-chip refund-btn" data-x="5">5ë°°</button>
        </div>
        <p class="hint">ë°°ìˆ˜ë¥¼ ì¶”ê°€í•˜ë©´ í™˜ë¶ˆ ë°°ìˆ˜ ì „ìš© ë£°ë ›ìœ¼ë¡œ ì „í™˜ë˜ë©°, ë‹¹ì²¨ ì‹œ ë²„ìŠ¤ë¹„ Ã— ë°°ìˆ˜ ê¸ˆì•¡ì„ ê³„ì‚°í•´ ì¤ë‹ˆë‹¤.</p>
      </div>

      <div class="controls-group" id="busGroup" style="display:none;">
        <div class="section-title">ëŒ€ì‹  í™˜ë¶ˆ ë£°ë ›</div>
        <label for="busCountSelect">ë²„ìŠ¤ ì¸ì›ìˆ˜ ì„ íƒ</label>
        <div class="row">
          <select id="busCountSelect">
            <option value="2">2ì¸</option>
            <option value="3">3ì¸</option>
            <option value="4">4ì¸</option>
            <option value="5">5ì¸</option>
            <option value="6">6ì¸</option>
          </select>
          <button class="btn-secondary btn-chip" id="applyBusPreset">ì¸ì›ìˆ˜ ì ìš©</button>
        </div>
        <p class="hint">ì„ íƒí•œ ì¸ì›ìˆ˜ë§Œí¼ 1ë²ˆ, 2ë²ˆ, 3ë²ˆ... í•­ëª©ì´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.</p>
      </div>
    </section>

    <section class="roulette-wrapper" id="rouletteWrapper">
      <div class="roulette-header">
        <div>
          <div class="roulette-title">ë£°ë › ë¯¸ë¦¬ë³´ê¸°</div>
          <div class="roulette-subtitle">ì˜µì…˜ì„ ìˆ˜ì •í•˜ë©´ ë£°ë ›ì— ë°”ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.</div>
        </div>
      </div>

      <div class="wheel-container">
        <div class="wheel-ring"></div>
        <div class="wheel-shell"></div>
        <div class="wheel" id="wheel"></div>
        <div class="wheel-labels" id="wheelLabels"></div>
        <div class="wheel-center"></div>
        <img class="pointer" src="https://github.com/heyrichoi/JJland/blob/main/ChatGPT%20Image%202025%EB%85%84%2011%EC%9B%94%2015%EC%9D%BC%20%EC%98%A4%EC%A0%84%2001_30_28.png?raw=true" alt="Pointer" />
      </div>

      <div class="result-box">
        <div class="result-title">ì´ë²ˆ ê²°ê³¼</div>
        <div class="result-value" id="resultValue"></div>
      </div>

      <button class="btn-primary" id="spinBtn">ğŸ¡ JJëœë“œ ë£°ë › ëŒë¦¬ê¸°</button>
    </section>
  </main>
</div>

<!-- âœ… í•œë²ˆë” ì´ë¯¸ì§€ ì˜¤ë²„ë ˆì´ (ë°œë™ ì‹œ ì ê¹ ë„ì›€) -->
<div class="one-more-overlay" id="oneMoreOverlay" aria-hidden="true">
  <img
    class="one-more-img"
    id="oneMoreImg"
    src="https://github.com/heyrichoi/JJland/blob/main/Gemini_Generated_Image_h9g4tgh9g4tgh9g4-removebg-preview.png?raw=true"
    alt="í•œë²ˆ ë”"
  />
</div>

<div class="result-overlay" id="resultOverlay">
  <div class="result-modal">
    <img
      class="result-modal-logo"
      id="resultModalLogo"
      src="https://github.com/heyrichoi/JJland/blob/main/ChatGPT_Image_2025%EB%85%84_11%EC%9B%94_15%EC%9D%BC_%EC%98%A4%ED%9B%84_06_09_27-removebg-preview.png?raw=true"
      alt="Result Logo"
      loading="eager"
      decoding="async"
      referrerpolicy="no-referrer"
    />
    <div class="fireworks"><div class="ring"></div></div>
    <div class="result-modal-text" id="resultModalText"></div>
    <div class="result-modal-sub">í™”ë©´ ì•„ë¬´ ê³³ì´ë‚˜ í´ë¦­í•˜ë©´ ë‹«í˜€ìš”</div>
  </div>
</div>

<script>
(function () {
  const presetSelect = document.getElementById('presetSelect');
  const donationModeBtn = document.getElementById('donationModeBtn');
  const itemCountInput = document.getElementById('itemCount');
  const itemsEditor = document.getElementById('itemsEditor');
  const removeOnWinCheckbox = document.getElementById('removeOnWin');
  const restorePrevBtn = document.getElementById('restorePrev');
  const currentOptionsEl = document.getElementById('currentOptions');
  const presetInitBtn = document.getElementById('presetInit');
  const refundBaseInput = document.getElementById('refundBase');
  const refundButtons = document.querySelectorAll('.refund-btn');
  const busGroup = document.getElementById('busGroup');
  const refundGroup = document.getElementById('refundGroup');
  const busCountSelect = document.getElementById('busCountSelect');
  const applyBusPresetBtn = document.getElementById('applyBusPreset');
  const addItemBtn = document.getElementById('addItemBtn');

  const rouletteWrapper = document.getElementById('rouletteWrapper');
  const wheel = document.getElementById('wheel');
  const wheelLabels = document.getElementById('wheelLabels');
  const spinBtn = document.getElementById('spinBtn');
  const resultValue = document.getElementById('resultValue');

  const resultOverlay = document.getElementById('resultOverlay');
  const resultModalText = document.getElementById('resultModalText');

  const donationExportWrap = document.getElementById('donationExportWrap');
  const donationExportText = document.getElementById('donationExportText');
  const copyDonationBtn = document.getElementById('copyDonationBtn');

  // âœ… í•œë²ˆë” ì´ë¯¸ì§€ ì˜¤ë²„ë ˆì´
  const oneMoreOverlay = document.getElementById('oneMoreOverlay');
  const oneMoreImg = document.getElementById('oneMoreImg');

  const colors = ['#f97316', '#38bdf8', '#a855f7', '#22c55e', '#ec4899', '#4f46e5', '#facc15', '#14b8a6'];

  // í† ìŠ¤íŠ¸
  const toastEl = document.createElement('div');
  toastEl.className = 'toast';
  toastEl.id = 'toast';
  document.body.appendChild(toastEl);
  let toastTimer = null;
  function showToast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toastEl.classList.remove('show'), 1200);
  }

  // âœ… í”„ë¦¬ì…‹ ìˆ˜ì •: TOP6/TOP9 ì œê±° / ê¸°ë³¸ = ì „ì²´ ìºë¦­í„° / í•­ëª© ìˆœì„œ ì§€ì •
  const presets = [
    {
      id: 'chars_all',
      label: 'ìºë¦­í„° ë£°ë › - ì „ì²´ ìºë¦­í„°',
      type: 'normal',
      items: ['ì°©í•´ì§„ì«€ì§€','ì«€ì§€','ì«€ë¹ˆí›„ë“œ','ì«€ìŠ¼','ì«€ì§€í¼','ë¹„ë¹„íƒ„ì«€','ì«€ì§€ìš©','ì«€ë‹¤ë¥´í¬','ë…¸í‚¤ì¦ˆì«€','ì«€ë‘ê´‘','ë¬´ì«€ë„ì‚¬']
    },
    { id: 'tries', label: 'íŠ¸ë¼ì´ íšŸìˆ˜ ë£°ë › - íŠ¸ë¼ì´ íšŸìˆ˜', type: 'normal', items: ['1íŠ¸','2íŠ¸','3íŠ¸'] },
    { id: 'deca', label: 'ë°ì¹´ ë£°ë › - ë°ì¹´ ì‚¬ìš© ì—¬ë¶€', type: 'normal', items: ['ë°ì¹´ ì‚¬ìš© ê°€ëŠ¥','ë°ì¹´ ì‚¬ìš© ë¶ˆê°€ëŠ¥'] },
    { id: 'refund', label: 'í™˜ë¶ˆ ë°°ìˆ˜ ë£°ë ›', type: 'refund', items: ['0ë°°','1ë°°','2ë°°','3ë°°'] },
    { id: 'bus', label: 'ëŒ€ì‹  í™˜ë¶ˆ ë£°ë ›', type: 'bus', items: [] },
    { id: 'custom', label: 'ì»¤ìŠ¤í…€ ë£°ë ›', type: 'normal', items: [] }
  ];

  const presetStorage = {};
  presets.forEach(p => (presetStorage[p.id] = [...p.items]));

  const multiplierMap = {
    '0ë°°': 0,
    '1ë°°': 1,
    '1.5ë°°': 1.5,
    '2ë°°': 2,
    '2.5ë°°': 2.5,
    '3ë°°': 3,
    '3.5ë°°': 3.5,
    '4ë°°': 4,
    '4.5ë°°': 4.5,
    '5ë°°': 5
  };

  let items = [];
  let currentPreset = presets.find(p => p.id === 'chars_all') || presets[0];
  let mode = 'normal';
  let lastRemoved = null;

  let currentSegments = [];
  let isDonationMode = false;
  let donationItems = [
    { name: '', weight: 1 },
    { name: '', weight: 1 }
  ];

  // --- ìœ í‹¸: ì›í˜• ì¸ì ‘(ì²«/ë í¬í•¨) ë™ì¼ìƒ‰ ë°©ì§€ ---
  function assignColors(count) {
    if (count <= 0) return [];
    const arr = Array.from({ length: count }, (_, i) => colors[i % colors.length]);
    if (count > 1 && arr[0] === arr[count - 1]) {
      let swapIdx = -1;
      for (let i = count - 2; i >= 1; i--) {
        const c = arr[i];
        if (c !== arr[0] && c !== arr[count - 2]) { swapIdx = i; break; }
      }
      if (swapIdx !== -1) {
        const tmp = arr[swapIdx];
        arr[swapIdx] = arr[count - 1];
        arr[count - 1] = tmp;
      } else {
        arr[count - 1] = colors[1 % colors.length];
      }
      if (arr[count - 1] === arr[count - 2]) {
        arr[count - 1] = colors[2 % colors.length];
      }
    }
    // ì¸ì ‘ ë™ì¼ìƒ‰(ì„ í˜•)ë„ ë°©ì§€
    for (let i = 1; i < count; i++) {
      if (arr[i] === arr[i - 1]) {
        arr[i] = colors[(i + 1) % colors.length];
        if (i === count - 1 && arr[i] === arr[0]) {
          arr[i] = colors[(i + 2) % colors.length];
        }
      }
    }
    return arr;
  }

  function buildDonationExportString() {
    const active = donationItems
      .map(e => ({ name: (e.name || '').trim(), weight: parseInt(e.weight, 10) }))
      .filter(e => e.name !== '' && Number.isFinite(e.weight) && e.weight > 0);
    return active.map(e => `${e.name}*${e.weight}`).join(',');
  }

  async function copyToClipboard(text) {
    try {
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
        return true;
      }
    } catch (_) {}

    try {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.setAttribute('readonly', '');
      ta.style.position = 'fixed';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.select();
      const ok = document.execCommand('copy');
      document.body.removeChild(ta);
      return ok;
    } catch (_) {
      return false;
    }
  }

  function showResultOverlay(text) {
    resultModalText.textContent = text;
    resultOverlay.style.display = 'flex';
  }

  resultOverlay.addEventListener('click', () => {
    resultOverlay.style.display = 'none';
    rouletteWrapper.classList.remove('fullscreen');
    const container = rouletteWrapper.querySelector('.wheel-container');
    container.style.transform = '';
  });

  // âœ… í•œë²ˆë” ì´ë¯¸ì§€ ì˜¤ë²„ë ˆì´ í‘œì‹œ í›„ ë‹¤ìŒ ë™ì‘
  function showOneMoreOverlayFor(ms = 1200) {
    return new Promise((resolve) => {
      // ì•ˆì „: ì´ë¯¸ì§€ê°€ ì•„ì§ ë¡œë”© ì¤‘ì´ì–´ë„ ì˜¤ë²„ë ˆì´ë¥¼ ë¨¼ì € ë„ì›€
      oneMoreOverlay.style.display = 'flex';
      // ê°•ì œ reflow
      void oneMoreOverlay.offsetWidth;
      oneMoreOverlay.classList.add('show');

      const finish = () => {
        oneMoreOverlay.classList.remove('show');
        // íŠ¸ëœì§€ì…˜ ë§ˆë¬´ë¦¬ í›„ display none
        setTimeout(() => {
          oneMoreOverlay.style.display = 'none';
          resolve();
        }, 220);
      };

      setTimeout(finish, ms);
    });
  }

  // ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ(ê¹œë¹¡ì„ ë°©ì§€)
  try {
    const pre1 = new Image();
    pre1.src = oneMoreImg.src;
    const pre2 = new Image();
    pre2.src = 'https://github.com/heyrichoi/JJland/blob/main/ChatGPT_Image_2025%EB%85%84_11%EC%9B%94_15%EC%9D%BC_%EC%98%A4%ED%9B%84_06_09_27-removebg-preview.png?raw=true';
  } catch (_) {}

  function initPresetSelect() {
    presetSelect.innerHTML = '';
    presets.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.label;
      presetSelect.appendChild(opt);
    });
    presetSelect.value = currentPreset.id;
  }

  function applyPreset(preset) {
    currentPreset = preset;
    mode = preset.type === 'refund' ? 'refundMultiplier' : 'normal';

    busGroup.style.display = 'none';
    refundGroup.style.display = 'none';

    if (preset.type === 'bus') {
      busGroup.style.display = 'block';
      if (presetStorage[preset.id].length === 0) {
        applyBusPreset();
      } else {
        items = presetStorage[preset.id];
        updateAll();
      }
    } else if (preset.type === 'refund') {
      refundGroup.style.display = 'block';
      items = presetStorage[preset.id];
      updateAll();
    } else {
      items = presetStorage[preset.id];
      updateAll();
    }

    const isCharacterPreset = ['chars_all'].includes(preset.id);
    const canRemove = !isDonationMode && isCharacterPreset;
    removeOnWinCheckbox.disabled = !canRemove;
    restorePrevBtn.disabled = !canRemove;
    if (!canRemove) {
      removeOnWinCheckbox.checked = false;
      lastRemoved = null;
    }
  }

  function refreshPresetUIWithoutReset() {
    busGroup.style.display = 'none';
    refundGroup.style.display = 'none';

    if (currentPreset.type === 'bus') {
      busGroup.style.display = 'block';
    } else if (currentPreset.type === 'refund') {
      refundGroup.style.display = 'block';
      mode = 'refundMultiplier';
    } else {
      mode = 'normal';
    }

    const isCharacterPreset = ['chars_all'].includes(currentPreset.id);
    const canRemove = !isDonationMode && isCharacterPreset;
    removeOnWinCheckbox.disabled = !canRemove;
    restorePrevBtn.disabled = !canRemove;
    if (!canRemove) {
      removeOnWinCheckbox.checked = false;
      lastRemoved = null;
    }
  }

  function applyBusPreset() {
    const n = parseInt(busCountSelect.value, 10) || 2;
    const newItems = Array.from({ length: n }, (_, i) => `${i + 1}ë²ˆ`);
    presetStorage[currentPreset.id] = newItems;
    items = presetStorage[currentPreset.id];
    updateAll();
  }

  function updateItemCountFromState() {
    itemCountInput.value = isDonationMode ? donationItems.length : items.length;
  }

  function createStackStepper(value, onChange) {
    const wrap = document.createElement('div');
    wrap.className = 'stack-stepper';

    const left = document.createElement('button');
    left.type = 'button';
    left.className = 'stack-btn';
    left.setAttribute('aria-label', 'ìŠ¤íƒ ê°ì†Œ');
    left.textContent = 'â—€';

    const mid = document.createElement('div');
    mid.className = 'stack-value';
    mid.textContent = String(value);

    const right = document.createElement('button');
    right.type = 'button';
    right.className = 'stack-btn';
    right.setAttribute('aria-label', 'ìŠ¤íƒ ì¦ê°€');
    right.textContent = 'â–¶';

    function set(v) {
      const nv = Math.max(1, parseInt(v, 10) || 1);
      mid.textContent = String(nv);
      onChange(nv);
    }

    left.addEventListener('click', () => set((parseInt(mid.textContent, 10) || 1) - 1));
    right.addEventListener('click', () => set((parseInt(mid.textContent, 10) || 1) + 1));

    wrap.appendChild(left);
    wrap.appendChild(mid);
    wrap.appendChild(right);
    return wrap;
  }

  function renderItemsEditor() {
    itemsEditor.innerHTML = '';

    if (isDonationMode) {
      donationItems.forEach((entry, idx) => {
        const row = document.createElement('div');
        row.className = 'item-row';

        const badge = document.createElement('div');
        badge.className = 'item-badge';
        badge.textContent = idx + 1;

        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.value = entry.name;
        nameInput.placeholder = 'ì´ë¦„';
        nameInput.addEventListener('input', () => {
          donationItems[idx].name = nameInput.value.trim();
          renderWheel();
          renderCurrentOptions();
        });

        const stepper = createStackStepper(entry.weight, (nv) => {
          donationItems[idx].weight = nv;
          renderWheel();
          renderCurrentOptions();
        });

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'item-remove';
        removeBtn.textContent = 'âœ•';
        removeBtn.addEventListener('click', () => {
          donationItems.splice(idx, 1);
          if (!donationItems.length) donationItems.push({ name: '', weight: 1 });
          updateAll();
        });

        row.appendChild(badge);
        row.appendChild(nameInput);
        row.appendChild(stepper);
        row.appendChild(removeBtn);
        itemsEditor.appendChild(row);
      });
      return;
    }

    items.forEach((text, idx) => {
      const row = document.createElement('div');
      row.className = 'item-row';

      const badge = document.createElement('div');
      badge.className = 'item-badge';
      badge.textContent = idx + 1;

      const input = document.createElement('input');
      input.type = 'text';
      input.value = text;
      input.addEventListener('input', () => {
        items[idx] = input.value.trim();
        renderWheel();
        renderCurrentOptions();
      });

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'item-remove';
      removeBtn.textContent = 'âœ•';
      removeBtn.addEventListener('click', () => {
        items.splice(idx, 1);
        updateAll();
      });

      row.appendChild(badge);
      row.appendChild(input);
      row.appendChild(removeBtn);
      itemsEditor.appendChild(row);
    });
  }

  function renderCurrentOptions() {
    currentOptionsEl.innerHTML = '';
    donationExportWrap.style.display = 'none';

    if (isDonationMode) {
      if (!donationItems.length) return;
      donationItems.forEach((e, idx) => {
        const span = document.createElement('span');
        const name = e.name || '(ë¹ˆ í•­ëª©)';
        span.textContent = `${idx + 1}. ${name} (ì§€ë¶„ ${e.weight})`;
        currentOptionsEl.appendChild(span);
      });

      const exportStr = buildDonationExportString();
      donationExportText.value = exportStr;
      donationExportWrap.style.display = 'block';
      copyDonationBtn.disabled = exportStr.trim() === '';
      return;
    }

    if (!items.length) return;
    items.forEach((t, idx) => {
      const span = document.createElement('span');
      span.textContent = `${idx + 1}. ${t || '(ë¹ˆ í•­ëª©)'}`;
      currentOptionsEl.appendChild(span);
    });
  }

  function renderWheel() {
    currentSegments = [];

    if (isDonationMode) {
      const active = donationItems.filter(e => e.name.trim() !== '' && e.weight > 0);
      if (!active.length) {
        wheel.style.background = 'radial-gradient(circle at 30% 20%, #020617, #020617)';
        wheelLabels.innerHTML = '';
        return;
      }

      const totalWeight = active.reduce((sum, e) => sum + e.weight, 0);
      const parts = [];
      let acc = 0;

      wheelLabels.innerHTML = '';
      const radius = wheel.offsetWidth / 2 || 120;
      const textRadius = radius - 30;
      const colorArr = assignColors(active.length);

      active.forEach((entry, i) => {
        const start = (acc / totalWeight) * 360;
        const end = ((acc + entry.weight) / totalWeight) * 360;
        acc += entry.weight;

        const color = colorArr[i];
        parts.push(`${color} ${start}deg ${end}deg`);

        const center0 = (start + end) / 2;
        const labelAngle = -90 + center0;
        const rad = (labelAngle * Math.PI) / 180;
        const x = Math.cos(rad) * textRadius;
        const y = Math.sin(rad) * textRadius;

        const label = document.createElement('div');
        label.className = 'slice-label';
        const span = document.createElement('span');
        span.textContent = entry.name;
        label.appendChild(span);

        label.style.left = '50%';
        label.style.top = '50%';
        label.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px) rotate(${labelAngle}deg)`;

        wheelLabels.appendChild(label);

        currentSegments.push({
          name: entry.name,
          startAngle: start,
          endAngle: end,
          centerAngle: center0,
          sliceAngle: end - start,
          weight: entry.weight
        });
      });

      wheel.style.background = `conic-gradient(${parts.join(',')})`;
      return;
    }

    const activeItems = items.filter(t => t.trim() !== '');
    const n = activeItems.length;
    const step = n ? 360 / n : 0;

    if (!n) {
      wheel.style.background = 'radial-gradient(circle at 30% 20%, #020617, #020617)';
      wheelLabels.innerHTML = '';
      return;
    }

    const parts = [];
    const colorArr = assignColors(n);

    for (let i = 0; i < n; i++) {
      const start = i * step;
      const end = (i + 1) * step;
      const color = colorArr[i];
      parts.push(`${color} ${start}deg ${end}deg`);

      const centerAngle = start + step / 2;
      currentSegments.push({
        name: activeItems[i],
        startAngle: start,
        endAngle: end,
        centerAngle,
        sliceAngle: step
      });
    }

    wheel.style.background = `conic-gradient(${parts.join(',')})`;

    wheelLabels.innerHTML = '';
    const radius = wheel.offsetWidth / 2;
    const textRadius = radius - 30;

    activeItems.forEach((text, i) => {
      const label = document.createElement('div');
      label.className = 'slice-label';
      const span = document.createElement('span');
      span.textContent = text;
      label.appendChild(span);

      const angle = -90 + step * i + step / 2;
      const rad = (angle * Math.PI) / 180;
      const x = Math.cos(rad) * textRadius;
      const y = Math.sin(rad) * textRadius;

      label.style.left = '50%';
      label.style.top = '50%';
      label.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px) rotate(${angle}deg)`;

      wheelLabels.appendChild(label);
    });
  }

  function updateAll() {
    updateItemCountFromState();
    renderItemsEditor();
    renderCurrentOptions();
    renderWheel();
  }

  function handleWin(winnerName) {
    let displayText = '';

    if (mode === 'refundMultiplier') {
      const base = parseFloat(refundBaseInput.value || '0');
      const m = multiplierMap[winnerName];
      if (base >= 0 && typeof m === 'number') {
        const amount = Math.round(base * m);
        displayText = `${winnerName} ë‹¹ì²¨!  ì•½ ${amount.toLocaleString()}ì›`;
      } else {
        displayText = `${winnerName} ë‹¹ì²¨!`;
      }
    } else {
      displayText = `${winnerName} ë‹¹ì²¨!`;
    }

    resultValue.textContent = displayText;
    showResultOverlay(displayText);

    if (removeOnWinCheckbox.checked && !isDonationMode) {
      let winnerOriginalIndex = -1;
      for (let i = 0; i < items.length; i++) {
        if (items[i].trim() === '') continue;
        if (items[i] === winnerName) { winnerOriginalIndex = i; break; }
      }
      if (winnerOriginalIndex !== -1) {
        lastRemoved = items[winnerOriginalIndex];
        items.splice(winnerOriginalIndex, 1);
        updateAll();
      }
    }
  }

  function applyWheelRotation(deg) {
    wheel.style.transform = `rotate(${deg}deg)`;
    wheelLabels.style.transform = `rotate(${deg}deg)`;
  }

  // âœ… í˜„ì¬ íšŒì „ê°ì—ì„œ í¬ì¸í„°(12ì‹œ)ê°€ ê°€ë¦¬í‚¤ëŠ” ì„¹ì…˜ì„ ê³„ì‚°
  function winnerFromRotation(rotationDeg) {
    if (!currentSegments.length) return null;

    const rot = ((rotationDeg % 360) + 360) % 360;
    const pointerAngleInWheel = ((360 - rot) % 360); // 0deg = 12ì‹œ

    const a = (pointerAngleInWheel === 360 ? 0 : pointerAngleInWheel);
    const eps = 1e-7;

    for (const seg of currentSegments) {
      const s = seg.startAngle;
      const e = seg.endAngle;
      if (a + eps >= s && a < e - eps) return seg.name;
    }

    return currentSegments[currentSegments.length - 1].name;
  }

  // ====== ìˆ˜ë™ ë©ˆì¶”ê¸°(ë¬¼ë¦¬ ê¸°ë°˜) ìŠ¤í•€ ìƒíƒœ ======
  let spinPhase = 'idle'; // 'idle' | 'spinning' | 'stopping'
  let currentRotation = 0; // deg
  let rafId = null;
  let lastTs = 0;

  // ì²´ê° ì†ë„(ë” ë¹ ë¥´ê²Œ)
  const SPIN_MIN_SPEED = 900;      // deg/s (ì‹œì‘)
  const SPIN_MAX_SPEED = 2200;     // deg/s (ìµœê³ ì†)
  const SPIN_ACCEL_TIME = 0.9;     // sec (ê°€ì† êµ¬ê°„)

  let spinStartTs = 0;
  let spinSpeed = SPIN_MIN_SPEED;

  // stop ì• ë‹ˆë©”ì´ì…˜ íŒŒë¼ë¯¸í„°
  let stopStartTs = 0;
  let stopDuration = 0;
  let stopStartSpeed = 0;

  function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }

  function startSpin() {
    if (spinPhase !== 'idle') return;
    if (!currentSegments.length) {
      showToast('í•­ëª©ì„ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”');
      return;
    }

    rouletteWrapper.classList.add('fullscreen');

    const margin = 40;
    const baseSize = 360;
    const minDimension = Math.min(window.innerWidth, window.innerHeight) - margin * 2;
    let scale = minDimension / baseSize;
    if (scale < 0.5) scale = 0.5;

    const container = rouletteWrapper.querySelector('.wheel-container');
    container.style.transform = `scale(${scale})`;

    wheel.style.transition = 'none';
    wheelLabels.style.transition = 'none';

    spinPhase = 'spinning';
    spinBtn.classList.add('stop-mode');
    spinBtn.disabled = false;
    spinBtn.textContent = 'â¹ ë©ˆì¶”ê¸°';

    lastTs = 0;
    spinStartTs = 0;
    spinSpeed = SPIN_MIN_SPEED;

    const tick = (ts) => {
      if (spinPhase !== 'spinning') return;

      if (!lastTs) lastTs = ts;
      const dt = Math.min(0.05, (ts - lastTs) / 1000);
      lastTs = ts;

      if (!spinStartTs) spinStartTs = ts;
      const t = (ts - spinStartTs) / 1000;

      if (t < SPIN_ACCEL_TIME) {
        const p = easeOutCubic(t / SPIN_ACCEL_TIME);
        spinSpeed = SPIN_MIN_SPEED + (SPIN_MAX_SPEED - SPIN_MIN_SPEED) * p;
      } else {
        spinSpeed = SPIN_MAX_SPEED;
      }

      currentRotation += spinSpeed * dt;
      applyWheelRotation(currentRotation);
      rafId = requestAnimationFrame(tick);
    };

    rafId = requestAnimationFrame(tick);
  }

  function shouldTriggerOneMore(rng = Math.random) {
    return currentSegments.length > 1 && rng() < 0.15;
  }

  let oneMoreInProgress = false;

  function requestStopSpin(isAutoStop = false) {
    if (spinPhase !== 'spinning') return;
    spinPhase = 'stopping';

    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;

    stopDuration = 5 + Math.random() * 8; // 5~13s
    stopStartTs = 0;
    lastTs = 0;

    spinBtn.disabled = true;
    spinBtn.classList.add('stop-mode');
    spinBtn.textContent = isAutoStop ? 'ğŸ² í•œë²ˆ ë” ì§„í–‰ ì¤‘...' : 'â³ ë©ˆì¶”ëŠ” ì¤‘...';

    stopStartSpeed = spinSpeed;

    const tickStop = (ts) => {
      if (spinPhase !== 'stopping') return;

      if (!lastTs) lastTs = ts;
      const dt = Math.min(0.05, (ts - lastTs) / 1000);
      lastTs = ts;

      if (!stopStartTs) stopStartTs = ts;
      const elapsed = (ts - stopStartTs) / 1000;
      const p = Math.min(1, elapsed / stopDuration);

      const k = 1 - easeOutCubic(p);
      const v = Math.max(0, stopStartSpeed * k);

      currentRotation += v * dt;
      applyWheelRotation(currentRotation);

      if (p >= 1) {
        spinPhase = 'idle';

        const winnerName = winnerFromRotation(currentRotation);

        // âœ… ìë™ ë©ˆì¶”ê¸°(=í•œë²ˆë” ìŠ¤í•€ì˜ ë)ë¼ë©´ ë°”ë¡œ ìµœì¢… ê²°ê³¼
        if (isAutoStop) {
          oneMoreInProgress = false;
          spinBtn.disabled = false;
          spinBtn.classList.remove('stop-mode');
          spinBtn.textContent = 'ğŸ¡ JJëœë“œ ë£°ë › ëŒë¦¬ê¸°';
          if (winnerName) handleWin(winnerName);
          return;
        }

        // âœ… ì‚¬ìš©ì ë©ˆì¶”ê¸° í›„: 15% í™•ë¥ ë¡œ í•œë²ˆë” ë°œë™
        if (winnerName && shouldTriggerOneMore()) {
          oneMoreInProgress = true;
          showToast('ğŸ² í•œë²ˆ ë”!');

          // âœ… ìš”ì²­: í•œë²ˆë” ë°œë™ ì‹œ ì´ë¯¸ì§€ê°€ ëœ¬ í›„ ëŒì•„ê°€ê¸°
          showOneMoreOverlayFor(1200).then(() => {
            startOneMoreSpin();
          });
          return;
        }

        // âœ… í•œë²ˆë” ë¯¸ë°œë™: í˜„ì¬ ë©ˆì¶˜ ê²°ê³¼ê°€ ìµœì¢…
        spinBtn.disabled = false;
        spinBtn.classList.remove('stop-mode');
        spinBtn.textContent = 'ğŸ¡ JJëœë“œ ë£°ë › ëŒë¦¬ê¸°';
        if (winnerName) handleWin(winnerName);
        return;
      }

      rafId = requestAnimationFrame(tickStop);
    };

    rafId = requestAnimationFrame(tickStop);
  }

  function startOneMoreSpin() {
    if (!currentSegments.length) {
      oneMoreInProgress = false;
      spinBtn.disabled = false;
      spinBtn.classList.remove('stop-mode');
      spinBtn.textContent = 'ğŸ¡ JJëœë“œ ë£°ë › ëŒë¦¬ê¸°';
      return;
    }

    wheel.style.transition = 'none';
    wheelLabels.style.transition = 'none';

    spinPhase = 'spinning';
    spinBtn.disabled = true; // í•œë²ˆë”ëŠ” ìë™ ë©ˆì¶”ê¸°
    spinBtn.classList.add('stop-mode');
    spinBtn.textContent = 'ğŸ² í•œë²ˆ ë” ì§„í–‰ ì¤‘...';

    lastTs = 0;
    spinStartTs = 0;
    spinSpeed = Math.min(SPIN_MAX_SPEED, Math.max(SPIN_MIN_SPEED, spinSpeed));

    const autoRunFor = 0.7 + Math.random() * 1.2; // 0.7~1.9s

    const tick = (ts) => {
      if (spinPhase !== 'spinning') return;

      if (!lastTs) lastTs = ts;
      const dt = Math.min(0.05, (ts - lastTs) / 1000);
      lastTs = ts;

      if (!spinStartTs) spinStartTs = ts;
      const t = (ts - spinStartTs) / 1000;

      const accelT = Math.min(0.55, SPIN_ACCEL_TIME * 0.7);
      if (t < accelT) {
        const p = easeOutCubic(t / accelT);
        spinSpeed = SPIN_MIN_SPEED + (SPIN_MAX_SPEED - SPIN_MIN_SPEED) * p;
      } else {
        spinSpeed = SPIN_MAX_SPEED;
      }

      currentRotation += spinSpeed * dt;
      applyWheelRotation(currentRotation);

      if (t >= autoRunFor) {
        if (rafId) cancelAnimationFrame(rafId);
        rafId = null;
        requestStopSpin(true);
        return;
      }

      rafId = requestAnimationFrame(tick);
    };

    rafId = requestAnimationFrame(tick);
  }

  function stopNowAndResetUI() {
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;
    spinPhase = 'idle';
    spinBtn.disabled = false;
    spinBtn.classList.remove('stop-mode');
    spinBtn.textContent = 'ğŸ¡ JJëœë“œ ë£°ë › ëŒë¦¬ê¸°';
  }

  function toggleSpin() {
    if (spinPhase === 'idle') startSpin();
    else if (spinPhase === 'spinning') {
      if (oneMoreInProgress) return; // í•œë²ˆë” ì¤‘ì—” í´ë¦­ ë¬´ì‹œ
      requestStopSpin(false);
    }
  }

  // --- ì´ë²¤íŠ¸ ë°”ì¸ë”© ---
  presetSelect.addEventListener('change', () => {
    const id = presetSelect.value;
    const preset = presets.find(p => p.id === id) || presets[0];
    if (isDonationMode) {
      currentPreset = preset;
      return;
    }
    applyPreset(preset);
  });

  presetInitBtn.addEventListener('click', () => {
    if (isDonationMode) {
      donationItems = [{ name: '', weight: 1 }, { name: '', weight: 1 }];
      updateAll();
    } else if (currentPreset) {
      const original = presets.find(p => p.id === currentPreset.id);
      if (original) {
        presetStorage[currentPreset.id] = [...original.items];
        items = presetStorage[currentPreset.id];
        updateAll();
      }
    }
  });

  itemCountInput.addEventListener('change', () => {
    let n = parseInt(itemCountInput.value, 10) || 1;
    n = Math.max(1, Math.min(20, n));

    if (isDonationMode) {
      const diff = n - donationItems.length;
      if (diff > 0) {
        for (let i = 0; i < diff; i++) donationItems.push({ name: '', weight: 1 });
      } else if (diff < 0) {
        donationItems.length = n;
      }
    } else {
      const diff = n - items.length;
      if (diff > 0) {
        for (let i = 0; i < diff; i++) items.push('');
      } else if (diff < 0) {
        items.length = n;
      }
    }

    updateAll();
  });

  addItemBtn.addEventListener('click', () => {
    if (isDonationMode) donationItems.push({ name: '', weight: 1 });
    else items.push('');

    updateAll();
    setTimeout(() => { itemsEditor.scrollTop = itemsEditor.scrollHeight; }, 0);
  });

  restorePrevBtn.addEventListener('click', () => {
    if (!lastRemoved || isDonationMode) return;
    items.push(lastRemoved);
    lastRemoved = null;
    updateAll();
  });

  refundButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      if (isDonationMode) return;
      const refundPreset = presets.find(p => p.id === 'refund');
      if (refundPreset && currentPreset.id !== 'refund') {
        presetSelect.value = 'refund';
        applyPreset(refundPreset);
      }
      mode = 'refundMultiplier';
      const label = `${btn.dataset.x}ë°°`;
      if (!items.includes(label)) items.push(label);
      updateAll();
    });
  });

  applyBusPresetBtn.addEventListener('click', () => {
    if (isDonationMode) return;
    applyBusPreset();
  });

  spinBtn.addEventListener('click', toggleSpin);

  donationModeBtn.addEventListener('click', () => {
    isDonationMode = !isDonationMode;

    if (spinPhase !== 'idle') stopNowAndResetUI();

    if (isDonationMode) {
      donationModeBtn.textContent = 'ì¼ë°˜ ë£°ë ›ìœ¼ë¡œ ì „í™˜';
      presetSelect.disabled = true;
      removeOnWinCheckbox.checked = false;
      removeOnWinCheckbox.disabled = true;
      restorePrevBtn.disabled = true;
      busGroup.style.display = 'none';
      refundGroup.style.display = 'none';
    } else {
      donationModeBtn.textContent = 'ë„ë„¤ ë£°ë ›ìœ¼ë¡œ ì „í™˜';
      presetSelect.disabled = false;
      refreshPresetUIWithoutReset();
    }

    updateAll();
  });

  copyDonationBtn.addEventListener('click', async () => {
    if (!isDonationMode) return;
    const exportStr = buildDonationExportString();
    donationExportText.value = exportStr;

    if (!exportStr.trim()) {
      showToast('ë³µì‚¬í•  í•­ëª©ì´ ì—†ì–´ìš”');
      return;
    }

    const ok = await copyToClipboard(exportStr);
    if (ok) showToast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    else showToast('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆì–´ìš”');
  });

  // --- Dev tests (URLì— ?test=1 ë¶™ì´ë©´ ì½˜ì†” í…ŒìŠ¤íŠ¸ ì‹¤í–‰) ---
  function runDevTests() {
    const assert = (cond, msg) => {
      if (!cond) throw new Error(`TEST FAIL: ${msg}`);
    };

    // Test 1: buildDonationExportString ê¸°ë³¸ í¬ë§·
    donationItems = [
      { name: 'ì§±êµ¬', weight: 5 },
      { name: 'ì§±ì•„', weight: 10 },
      { name: 'ë´‰ë¯¸ì„ ', weight: 3 }
    ];
    assert(buildDonationExportString() === 'ì§±êµ¬*5,ì§±ì•„*10,ë´‰ë¯¸ì„ *3', 'buildDonationExportString basic');

    // Test 2: ë¹ˆ ì´ë¦„ ì œì™¸
    donationItems = [
      { name: 'ì§±êµ¬', weight: 5 },
      { name: '', weight: 10 },
      { name: 'ë´‰ë¯¸ì„ ', weight: 3 }
    ];
    assert(buildDonationExportString() === 'ì§±êµ¬*5,ë´‰ë¯¸ì„ *3', 'exclude empty names');

    // Test 3: 0/ìŒìˆ˜/NaN ì§€ë¶„ ì œì™¸
    donationItems = [
      { name: 'ì§±êµ¬', weight: 0 },
      { name: 'ì§±ì•„', weight: -2 },
      { name: 'ë´‰ë¯¸ì„ ', weight: 'abc' },
      { name: 'ìœ ë¦¬', weight: 2 }
    ];
    assert(buildDonationExportString() === 'ìœ ë¦¬*2', 'exclude invalid weights');

    // Test 4: assignColors - ì›í˜• ì¸ì ‘(ì²«/ë) ë™ì¼ìƒ‰ ë°©ì§€
    const c2 = assignColors(2);
    assert(c2.length === 2, 'assignColors length');
    assert(c2[0] !== c2[1], 'assignColors adjacent');

    const c9 = assignColors(9);
    assert(c9.length === 9, 'assignColors length 9');
    assert(c9[0] !== c9[8], 'assignColors circular neighbor');

    // Test 5: shouldTriggerOneMore - RNG ì£¼ì… í…ŒìŠ¤íŠ¸
    currentSegments = [{ name: 'A', startAngle: 0, endAngle: 180 }, { name: 'B', startAngle: 180, endAngle: 360 }];
    assert(shouldTriggerOneMore(() => 0.10) === true, 'oneMore triggers when rng < 0.15');
    assert(shouldTriggerOneMore(() => 0.90) === false, 'oneMore not trigger when rng >= 0.15');

    currentSegments = [{ name: 'A', startAngle: 0, endAngle: 360 }];
    assert(shouldTriggerOneMore(() => 0.01) === false, 'oneMore disabled when only 1 segment');

    // Test 6: winnerFromRotation - 4ë“±ë¶„ í…ŒìŠ¤íŠ¸ (0deg=12ì‹œ)
    currentSegments = [
      { name: 'A', startAngle: 0, endAngle: 90 },
      { name: 'B', startAngle: 90, endAngle: 180 },
      { name: 'C', startAngle: 180, endAngle: 270 },
      { name: 'D', startAngle: 270, endAngle: 360 }
    ];
    assert(winnerFromRotation(0) === 'A', 'winner rot0 -> A');
    assert(winnerFromRotation(90) === 'D', 'winner rot90 -> D');
    assert(winnerFromRotation(180) === 'C', 'winner rot180 -> C');
    assert(winnerFromRotation(270) === 'B', 'winner rot270 -> B');

    // Test 7: oneMore overlay element exists
    assert(!!document.getElementById('oneMoreOverlay'), 'oneMore overlay exists');
    assert(!!document.getElementById('oneMoreImg'), 'oneMore image exists');

    console.log('All dev tests passed');
  }

  try {
    if (new URLSearchParams(location.search).get('test') === '1') {
      runDevTests();
    }
  } catch (e) {
    console.warn('Dev tests skipped:', e);
  }

  // ì´ˆê¸°í™”
  initPresetSelect();
  applyPreset(currentPreset);
})();
</script>
</body>
</html>
